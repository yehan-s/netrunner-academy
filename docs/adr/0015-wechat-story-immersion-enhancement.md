# ADR 0015：微信剧情沉浸感与教学体验增强

## 状态
Accepted（已实现 P0 + P1）

## 背景
- 当前微信剧情模式已实现基础功能：消息推进、关卡 gating、线索同步、localStorage 持久化。
- 但在沉浸感和教学设计上存在明显短板：
  1. **剧情节奏平淡**：事故处理流水账式叙事，缺少情绪曲线和转折点。
  2. **私聊/群聊比例失衡**：私聊内容太少，缺少职场真实的多线沟通压力。
  3. **UI 真实性不足**：缺少时间戳、"正在输入"动画、已读状态等微信特征。
  4. **教学铺垫缺失**：任务直接抛出，没有 NPC 的引导暗示，"先教再考"落实不够。
  5. **任务孤立**：各关卡相对独立，缺少线索串联和推理链。
- 用户反馈希望剧情更"真实"，能体验到线上事故处理的紧张感和团队协作氛围。

## 决策

### 1. 消息系统增强
在 `StoryMessage` 类型中扩展字段：
```typescript
interface StoryMessage {
  id: string;
  sender: '你' | '同事' | '安全负责人' | '产品' | '运维' | '客服';
  channel: 'WeChat';
  text: string;
  timestamp?: string;           // 新增：消息时间戳 "19:02"
  typingDelay?: number;         // 新增：显示"正在输入"的时长(ms)
  targetCaseId?: string;
  requiresClueSync?: boolean;
  clueKey?: string;
  condition?: string;           // 新增：条件表达式，支持分支剧情
}
```

### 2. UI 体验优化
- **时间戳显示**：每条消息旁显示发送时间，增强时间线感知。
- **"正在输入"动画**：消息出现前显示 typing indicator，模拟真实微信体验。
- **消息淡入动画**：消息不再瞬间出现，而是带有 slide-in + fade-in 效果。
- **已读/未读标记**：私聊消息显示已读状态（可选）。

### 3. 剧情内容增强
- **丰富角色**：增加"产品经理"、"运维"、"客服"等角色，模拟真实事故群的多方沟通。
- **增加私聊比例**：每 3-4 条群聊后穿插 1-2 条私聊，展示幕后情绪和压力。
- **情绪曲线设计**：
  - 开场：轻松下班氛围 → 突然报警
  - 中段：排查焦虑 → 发现问题 → 临时止血
  - 高潮：多问题并发 → 团队协作
  - 收尾：问题稳定 → 复盘讨论
- **闲聊调剂**：在大任务后插入点外卖、吐槽加班等闲聊，缓解紧张感。

### 4. 教学设计优化
- **任务前铺垫**：在 `targetCaseId` 消息前 1-2 条，加入教学暗示性对话。
  - 例："你知道怎么用 Reqable 看 Response Headers 吗？"
- **失败引导**：关卡失败后，NPC 发送提示消息而非直接卡住。
- **线索串联**：设计任务间的因果关系，前一个任务的发现引出下一个任务。

### 5. 线索面板可视化（P2）
- 在聊天窗口旁增加"证据板"侧边栏。
- 完成任务后自动将关键信息（截图占位符、日志摘要）贴到证据板。
- 支持导出"事故时间线"供复盘。

### 6. 分支剧情系统（P2）
- 支持 `condition` 字段，根据玩家表现展示不同消息。
- 快速完成 → "老板表扬"支线。
- 超时/多次失败 → "紧急复盘"支线。

## 实施优先级

| 优先级 | 功能 | 工作量 | 影响 |
|--------|------|--------|------|
| P0 | 消息时间戳 | 小 | 基础沉浸感 |
| P0 | "正在输入"动画 | 小 | 真实感提升明显 |
| P0 | 消息淡入动画 | 小 | 视觉体验 |
| P1 | 丰富私聊内容 | 中 | 剧情深度 |
| P1 | 增加更多角色 | 中 | 场景真实性 |
| P1 | 任务前教学暗示 | 中 | 教学体验 |
| P2 | 线索面板可视化 | 大 | 高级功能 |
| P2 | 分支剧情系统 | 大 | 可玩性 |

## 影响
- `storylines.ts`：StoryMessage 类型扩展，现有剧情需补充 `timestamp` 字段。
- `components/wechat/`：StoryChatPanel 需实现 typing indicator、时间戳、动画。
- `useWeChatStoryState.ts`：可能需要支持条件消息的计算逻辑。
- 测试：需要更新 E2E 测试以适应动画延迟，避免因 typing delay 导致超时。
- 向后兼容：新字段均为可选，现有剧情无需立即修改即可运行。

## 替代方案
1. **不做 UI 动画**：保持现有瞬间出现的消息，但沉浸感较差。
2. **不扩展角色**：只用现有三个角色，但场景单一。
3. **不做分支剧情**：线性剧情更简单，但可玩性受限。

## 参考
- 微信桌面版 UI 规范
- Telegram/Slack 的 typing indicator 实现
- 叙事游戏（如 Lifeline、A Normal Lost Phone）的消息系统设计
