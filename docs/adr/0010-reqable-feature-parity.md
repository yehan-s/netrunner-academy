# ADR-010: Reqable 功能完整性还原方案

## 状态
提议 (Proposed)

## 日期
2025-01-23

## 背景 (Context)

NetRunner Academy 的核心教学目标是让用户在游戏中学会真实的网络抓包工具使用方法。Reqable 是我们选择模拟的工具，但当前实现与官方功能存在较大差距。

### 官方文档来源
- 官网：https://reqable.com/zh-CN/
- 文档：https://reqable.com/zh-CN/docs/introduction/

### 教学真实性原则
**"游戏中学会的操作 = 真实工具中的操作"**

如果用户在游戏中学习了错误或不完整的工具用法，迁移到真实环境会产生困惑，违背教学目标。

## 决策 (Decision)

我们将采用**渐进式功能补全策略**，优先实现教学文档中涉及的功能，确保：
1. UI 布局与真实工具一致
2. 核心交互逻辑真实（快捷键、右键菜单、拖拽等）
3. 功能命名与官方文档一致

## 功能对照表 (Feature Parity Matrix)

### ✅ 已实现功能

| 功能分类 | 功能点 | 实现度 | 备注 |
|---------|--------|--------|------|
| **列表视图** | 流量列表显示 | 90% | 缺少列自定义 |
| **列表视图** | 过滤器（All/Http/Https等） | 100% | ✅ 完整 |
| **列表视图** | 搜索框 | 80% | 缺少高级搜索 |
| **详情面板** | Overview 面板 | 100% | ✅ 完整 |
| **详情面板** | Headers 查看 | 100% | ✅ 完整 |
| **详情面板** | Body 查看（Pretty/Raw） | 100% | ✅ 完整 |
| **详情面板** | Cookies 查看 | 100% | ✅ 完整 |
| **标签页** | 多 Tab 管理 | 100% | ✅ 完整 |
| **Composer** | 请求编辑器 | 90% | 缺少 Auth 配置 |
| **Composer** | Headers/Body/Params 编辑 | 100% | ✅ 完整 |
| **右键菜单** | Copy URL/cURL | 100% | ✅ 今日修复定位问题 |
| **右键菜单** | Edit in Composer | 100% | ✅ 完整 |
| **右键菜单** | Repeat Request | 100% | ✅ 完整 |
| **侧边栏** | Collections | 50% | 仅有示例 |
| **侧边栏** | History | 20% | 仅 UI 框架 |
| **侧边栏** | Script | 50% | 编辑器存在，缺执行 |
| **断点** | Toggle Breakpoints | 80% | 功能存在但未完全测试 |

### ❌ 缺失的关键功能

| 优先级 | 功能分类 | 功能点 | 教学文档引用 | 实现难度 |
|-------|---------|--------|------------|---------|
| **P0** | SSL | 证书管理界面 | 第6课 HTTPS证书配置 | 中 |
| **P0** | 重写 | 重写规则配置 | 第5课 流量拦截与修改 | 高 |
| **P0** | 断点 | 断点修改界面 | 第5课 流量拦截与修改 | 高 |
| **P0** | HAR | HAR 导入导出 | 第8课 真实场景调试 | 中 |
| **P1** | 网关 | 域名/URL 屏蔽规则 | - | 中 |
| **P1** | 镜像 | 域名端口映射 | - | 中 |
| **P1** | 脚本 | Python 脚本执行 | - | 高 |
| **P1** | 历史记录 | 持久化存储 | - | 低 |
| **P1** | 高亮 | 自定义高亮规则 | - | 低 |
| **P2** | 访问控制 | 黑白名单配置 | - | 低 |
| **P2** | 网络环境 | 节流/延迟模拟 | - | 中 |
| **P2** | 对比 | Diff 工具 | - | 中 |
| **P2** | 反向代理 | 反向代理配置 | - | 高 |
| **P3** | 代理终端 | 终端代理设置 | - | 低 |
| **P3** | Charles | .chls 文件支持 | - | 低 |
| **P3** | 极速模式 | 性能优化模式 | - | 低 |

## 渐进式实现路线图

### Phase 1: P0 功能补全（教学文档依赖）
**目标**：确保 8 节教学文档中的所有操作可在模拟器中完成

1. **SSL 证书管理**
   - UI: 证书管理对话框
   - 功能: 模拟证书安装流程（教学演示）
   - 关联课程: 第6课

2. **断点增强**
   - UI: 断点修改对话框（Request/Response）
   - 功能: 实时拦截并修改请求/响应体
   - 关联课程: 第5课

3. **重写规则**
   - UI: 重写规则配置面板
   - 功能: URL 重定向、Header 修改、Body 替换
   - 关联课程: 第5课

4. **HAR 支持**
   - 功能: 导出当前会话为 HAR
   - 功能: 从 HAR 导入历史流量
   - 关联课程: 第8课

### Phase 2: P1 功能完善（核心抓包工具能力）

1. **网关规则**
   - 阻止特定域名/URL 的请求

2. **镜像规则**
   - 域名映射（如 api.prod.com → api.dev.com）

3. **历史记录持久化**
   - LocalStorage 存储历史会话

4. **高亮规则**
   - 根据 URL/状态码/大小自定义行颜色

5. **脚本执行**
   - 简化的 Python 脚本执行（非真实解释器）

### Phase 3: P2/P3 锦上添花功能

暂缓实现，优先确保 Phase 1/2 质量。

## 备选方案 (Alternatives Considered)

### 备选方案 A: 完全重写，对标 Reqable 3.0

- **优势**: 功能完整
- **为何未选择**:
  - 开发周期过长（预计 3-6 个月）
  - 游戏教学只需要核心功能的 60-70%
  - 边际效益递减（P3 功能教学价值低）

### 备选方案 B: 只实现当前关卡需要的功能

- **优势**: 快速交付
- **为何未选择**:
  - 用户可能探索教程外的功能
  - 无法支持未来新关卡扩展
  - 不符合"真实性优先"原则

### 备选方案 C: 使用真实 Reqable API（如果有）

- **优势**: 100% 真实
- **为何未选择**:
  - Reqable 不提供 Web API
  - 无法控制教学流程
  - 离线不可用

## 后果 (Consequences)

### 正面影响

1. **教学质量提升**: 用户学到的是真实技能
2. **工具迁移成本为零**: 游戏→真实工具无缝切换
3. **口碑传播**: "在游戏里真的学会了抓包"

### 负面影响与缓解措施

1. **开发工作量增加**
   - **缓解**: 采用渐进式实现，Phase 1 优先
   - **量化**: Phase 1 预计 2-3 周开发时间

2. **组件复杂度提升**
   - **缓解**: 拆分 ReqableSimulator 为子组件
   - **措施**: 创建 `/components/reqable/` 目录

3. **测试覆盖困难**
   - **缓解**: 优先为 P0 功能编写 E2E 测试
   - **措施**: 每个功能完成后立即补充测试用例

## 技术债务预警

当前 `ReqableSimulator.tsx` 已达 **2000+ 行**，继续增加功能会导致：
- 难以维护
- 性能下降
- 测试困难

**强制要求**: Phase 1 开始前必须完成组件拆分重构（见 ADR-011）

## 验收标准

Phase 1 完成的定义：
- [ ] 所有 P0 功能 UI 完成
- [ ] 所有 P0 功能通过手动测试
- [ ] 至少 1 个 P0 功能有 E2E 测试
- [ ] 教学文档第 5/6 课所有操作可在模拟器中完成
- [ ] 代码审查通过（无明显技术债务）

## 参考资料

- [Reqable 官方文档](https://reqable.com/zh-CN/docs/introduction/)
- [教学文档: 第5课 流量拦截与修改](docs/lessons/05-breakpoint-and-modification.md)
- [教学文档: 第6课 HTTPS证书配置](docs/lessons/06-https-certificate-setup.md)
- [教学文档: 第8课 真实场景调试](docs/lessons/08-real-world-scenarios.md)
