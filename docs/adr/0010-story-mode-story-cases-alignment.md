# ADR 0010：微信剧情模式与 Story 关卡一一对齐

## 状态

Accepted（已采纳）

## 背景

ADR 0008、0009 已经引入微信剧情模式和关卡联动机制，但早期实现为了复用既有 `case_01`~`case_04`，在剧情文案与实际关卡行为之间存在明显割裂：  
例如剧情 1 描述的是“微信投放落地页、CDN 缓存未刷新、新旧 JS 版本切换”的场景，而旧关卡仍然是简单的登录 500 + v2 接口提示，无法与聊天内容一一对应。

为了保证教学真实性和叙事一致性，需要为微信剧情模式提供独立的 Story 关卡（`story_01_*` 系列），并让每一条带任务指令的微信消息，与一个语义完全匹配的 Story 关卡绑定。

## 决策

- 在 `constants.ts` 中新增并使用 `story_01_login_outage`、`story_02_price_tampering`、`story_03_sql_injection`、`story_04_idor` 四个剧情专用关卡，不再直接让剧情跳转到 `case_01`~`case_04`。  
- 在 `engine/networkEngine.ts` 中让 `story_*` 与对应 `case_*` 共用底层流量/后端模拟逻辑，但逐步调整 Story 关卡的 `initialUrl`、页面文案与引导步骤，使之严格贴合微信聊天中的事故叙述：
  - 剧情 1：从“微信投放落地页 + CDN 缓存老 JS”视角出发，强调静态资源版本与刷新验证，而不是抽象的“某登录接口 500”。  
  - 剧情 2：围绕“0.01 元买会员”的现实对账场景，突出会员/优惠等业务语义。  
  - 剧情 3：使用员工搜索/内部信息泄露的语境，匹配聊天中的 HR 查询事故。  
  - 剧情 4：在订单详情中明确展示姓名/地址等敏感字段，体现越权后果。
- 在 `storylines.ts` 中，所有带 `targetCaseId` 的消息一律指向 `story_*` 关卡，避免再出现“剧情 1 描述 CDN / JS，游戏里却是纯登录接口”的出戏感。
- 在 `WeChatStoryApp` 中使用 `localStorage` 持久化剧情进度，并在到达带 `targetCaseId` 的消息后，禁止继续推进，直到对应 Story 关卡在主界面中通关为止。

## 影响

- 剧情对话中的每一个任务节点，都能在游戏中找到内容、步骤和反馈完全一致的 Story 关卡，玩家不会再看到“微信聊天说 A，关卡却做 B”。  
- 通过与既有 `case_*` 共用模拟引擎，避免重复造轮子，同时允许后续逐步把 Story 关卡的 UI/文案彻底调整为“微信投放事故+真实工具操作”的教学版本。  
- ADR 0009 中“当前实现复用既有关卡，后续可扩展为独立剧情关卡”的描述已经被本决策实质性 supersede，但文件保留用于追踪演进历史。

