# å¾®ä¿¡å‰§æƒ…æ¨¡å¼ - å†™ä½œè§„èŒƒä¸æ ‡å‡†æµç¨‹

> æœ¬æ–‡æ¡£è®°å½• WeChat å‰§æƒ…æ¨¡å¼çš„å†…å®¹å†™ä½œè§„èŒƒï¼Œç¡®ä¿å‰§æƒ…æ²‰æµ¸æ„Ÿå’Œæ•™å­¦æ•ˆæœã€‚

---

## ä¸€ã€å‰§æƒ…æ•°æ®ç»“æ„

### StoryMessage æ¥å£

```typescript
interface StoryMessage {
  id: string;                    // åœºæ™¯ IDï¼Œå¦‚ 'scene-01', 'scene-13a'
  sender: SenderType;            // å‘é€è€…è§’è‰²
  channel: 'WeChat';             // å›ºå®šä¸º WeChat
  text: string;                  // æ¶ˆæ¯å†…å®¹ï¼Œéœ€åŒ…å« ã€ç¾¤èŠã€‘æˆ–ã€ç§èŠã€‘å‰ç¼€
  timestamp?: string;            // æ¶ˆæ¯æ—¶é—´æˆ³ï¼Œå¦‚ '19:02'
  typingDelay?: number;          // "æ­£åœ¨è¾“å…¥"åŠ¨ç”»æ—¶é•¿(ms)ï¼Œé»˜è®¤ 800
  targetCaseId?: string;         // ç»‘å®šçš„å…³å¡ IDï¼ˆè§¦å‘ gatingï¼‰
  requiresClueSync?: boolean;    // æ˜¯å¦éœ€è¦åŒæ­¥çº¿ç´¢
  clueKey?: string;              // çº¿ç´¢æ ‡è¯†
}
```

### è§’è‰²ç±»å‹ä¸å¤´åƒé¢œè‰²

| è§’è‰² | sender å€¼ | å¤´åƒé¢œè‰² | è¯´è¯é£æ ¼ |
|------|-----------|----------|----------|
| ç©å®¶ | `'ä½ '` | ç°è‰²ï¼ˆå¸¦å¤´åƒï¼‰ | æŠ€æœ¯åˆ†æã€è§£å†³æ–¹æ¡ˆ |
| åŒäº‹ | `'åŒäº‹'` | è“è‰² `bg-blue-600` | åä½œã€æ±‚åŠ©ã€åæ§½ |
| å®‰å…¨è´Ÿè´£äºº | `'å®‰å…¨è´Ÿè´£äºº'` | çº¢è‰² `bg-red-600` | æŒ‡æŒ¥ã€å†³ç­–ã€é¼“åŠ± |
| äº§å“ | `'äº§å“'` | ç´«è‰² `bg-purple-600` | å…³å¿ƒæ•°æ®ã€ç”¨æˆ·å½±å“ |
| è¿ç»´ | `'è¿ç»´'` | æ©™è‰² `bg-orange-600` | æœåŠ¡å™¨çŠ¶æ€ã€ä¸´æ—¶æ–¹æ¡ˆ |
| å®¢æœ | `'å®¢æœ'` | é’è‰² `bg-teal-600` | è½¬å‘ç”¨æˆ·åé¦ˆã€æˆªå›¾ |
| è€æ¿ | `'è€æ¿'` | ç¥ç€è‰² `bg-amber-700` | å…³å¿ƒè¿›å±•ã€åè°ƒèµ„æº |

---

## äºŒã€æ—¶é—´æˆ³è§„èŒƒ

### æ—¶é—´çº¿è®¾è®¡åŸåˆ™

1. **äº‹æ•…å‘ç”Ÿæ—¶é—´**ï¼šé€šå¸¸è®¾å®šåœ¨æ™šé«˜å³°ï¼ˆ19:00-21:00ï¼‰
2. **æ—¶é—´é—´éš”**ï¼š
   - ç´§æ€¥æ¶ˆæ¯ï¼š2-3 åˆ†é’Ÿé—´éš”
   - æ™®é€šå¯¹è¯ï¼š5-8 åˆ†é’Ÿé—´éš”
   - ä»»åŠ¡å®Œæˆåï¼š10-15 åˆ†é’Ÿè·³è·ƒ
3. **è·¨çº¿ç¨‹æ—¶é—´**ï¼šä¸åŒå‰§æƒ…çº¿æ—¶é—´åº”æœ‰æ˜æ˜¾åˆ†éš”

### ç¤ºä¾‹æ—¶é—´çº¿

```
äº‹æ•…å¤„ç†ç¾¤å‰§æƒ… (INCIDENT_STORY_THREAD):
19:02 - äº‹æ•…å¼€å§‹
19:06 - åˆæ­¥åˆ†æ
19:14 - ä»»åŠ¡ 1 (CDN éªŒè¯)
19:26 - ä»»åŠ¡ 2 (ä»·æ ¼ç¯¡æ”¹)
19:42 - ä»»åŠ¡ 3 (SQL æ³¨å…¥)
20:12 - ä»»åŠ¡ 4 (IDOR)
20:18 - ä»»åŠ¡ 5 (åŸ‹ç‚¹)
...
21:35 - äº‹æ•…æ”¶å°¾

Polyfill ä¾›åº”é“¾å‰§æƒ… (POLYFILL_SUPPLY_CHAIN_THREAD):
22:00 - æ–°é—®é¢˜å‡ºç°
22:25 - ä»»åŠ¡å¼€å§‹
...
23:45 - å‰§æƒ…ç»“æŸ
```

---

## ä¸‰ã€typingDelay é…ç½®

### ä½¿ç”¨åœºæ™¯

| åœºæ™¯ | typingDelay å€¼ | è¯´æ˜ |
|------|----------------|------|
| çŸ­æ¶ˆæ¯ | ä¸è®¾ç½®ï¼ˆé»˜è®¤ 800msï¼‰ | æ™®é€šç®€çŸ­å›å¤ |
| ä¸­ç­‰æ¶ˆæ¯ | `1000-1200` | å¸¦åˆ†æçš„æ¶ˆæ¯ |
| é•¿æ¶ˆæ¯/ä»»åŠ¡æŒ‡æ´¾ | `1200-1500` | é‡è¦æŒ‡ä»¤ã€ä»»åŠ¡è¯´æ˜ |
| ç©å®¶æ¶ˆæ¯ | ä¸è®¾ç½® | ç©å®¶æ¶ˆæ¯ä¸æ˜¾ç¤º typing |

### é…ç½®ç¤ºä¾‹

```typescript
{
  id: 'scene-07',
  sender: 'å®‰å…¨è´Ÿè´£äºº',
  text: 'ã€ç¾¤èŠã€‘å…ˆèµ°ä¸´æ—¶æ­¢è¡€ï¼šCDN å¯¹è¿™å¥—é™æ€èµ„æºåšä¸€æ¬¡å…¨é‡åˆ·æ–°...',
  timestamp: '19:14',
  typingDelay: 1500,  // ä»»åŠ¡æŒ‡æ´¾ï¼Œå»¶è¿Ÿè¾ƒé•¿
  targetCaseId: 'story_01_login_outage',
}
```

---

## å››ã€æ¶ˆæ¯ç±»å‹ä¸å†™ä½œæŠ€å·§

### 4.1 ç¾¤èŠæ¶ˆæ¯

- å‰ç¼€ `ã€ç¾¤èŠã€‘`
- å†…å®¹è¦åƒçœŸå®å·¥ä½œç¾¤ï¼šç®€æ´ã€å¸¦æŠ€æœ¯æœ¯è¯­ã€å¶å°”æœ‰é”™åˆ«å­—
- é¿å…è¿‡äºæ­£å¼çš„ä¹¦é¢è¯­

```typescript
// âœ… å¥½çš„å†™æ³•
text: 'ã€ç¾¤èŠã€‘DB èŠ‚ç‚¹ CPU æ‰“æ»¡ï¼Œæ…¢æŸ¥è¯¢æ—¥å¿—åˆ·å±ï¼Œçœ‹ç€åƒåœ¨æ‰«å…¨è¡¨ã€‚'

// âŒ é¿å…
text: 'ã€ç¾¤èŠã€‘å°Šæ•¬çš„å„ä½åŒäº‹ï¼Œæ•°æ®åº“æœåŠ¡å™¨çš„ CPU ä½¿ç”¨ç‡å·²è¾¾åˆ°æœ€å¤§å€¼...'
```

### 4.2 ç§èŠæ¶ˆæ¯

- å‰ç¼€ `ã€ç§èŠã€‘`
- å†…å®¹æ›´ç§äººåŒ–ï¼šåæ§½ã€é¼“åŠ±ã€æƒ…ç»ªå®£æ³„
- å¯ä»¥ç”¨ emoji å¢åŠ çœŸå®æ„Ÿ

```typescript
// åæ§½å‹
text: 'ã€ç§èŠã€‘è¯´å®è¯è¿™å‘¨çœŸçš„å¤ªç´¯äº†ï¼Œè¿ç€ä¸‰ä¸ªæ™šä¸ŠåŠ ç­ã€‚ç­‰è¿™æ³¢è¿‡å»è¯·ä½ å–å¥¶èŒ¶ ğŸ§‹'

// é¼“åŠ±å‹
text: 'ã€ç§èŠã€‘ä»Šæ™šè¾›è‹¦ä½ äº†ï¼Œå¤„ç†å¾—å¾ˆä¸“ä¸šã€‚ç­‰è¿™æ³¢è¿‡å»æˆ‘è¯·å¤§å®¶æ’¸ä¸² ğŸ¢'
```

### 4.3 æ•™å­¦é“ºå«æ¶ˆæ¯

- åœ¨ `targetCaseId` æ¶ˆæ¯å‰ 1-2 æ¡
- è‡ªç„¶å¼•å‡ºå³å°†ç”¨åˆ°çš„æŠ€æœ¯/å·¥å…·
- **ä¸è¦**å¸¦ `targetCaseId`ï¼Œé¿å…è§¦å‘ gating

```typescript
// story_01 (Reqable æŠ“åŒ…) å‰çš„é“ºå«
{
  id: 'scene-06a',
  sender: 'åŒäº‹',
  text: 'ã€ç¾¤èŠã€‘ä½ ä¼šç”¨ Reqable å—ï¼Ÿå¬è¯´æŠ“ HTTPS æ¯” Charles æ–¹ä¾¿...',
  timestamp: '19:13',
}

// story_03 (SQL æ³¨å…¥) å‰çš„é“ºå«
{
  id: 'scene-13b',
  sender: 'å®‰å…¨è´Ÿè´£äºº',
  text: 'ã€ç¾¤èŠã€‘SQL æ³¨å…¥ä½ äº†è§£å—ï¼Ÿæœç´¢æ¥å£é‚£è¾¹çš„å†™æ³•æˆ‘æœ‰ç‚¹æ‹…å¿ƒ...',
  timestamp: '19:40',
}
```

### 4.4 é—²èŠè°ƒå‰‚æ¶ˆæ¯

- æ’å…¥åœ¨ä»»åŠ¡å®Œæˆåæˆ–ç´§å¼ å‰§æƒ…ä¸­é—´
- æ¨¡æ‹ŸçœŸå®åŠ ç­åœºæ™¯
- ç¼“è§£ç©å®¶å‹åŠ›

```typescript
// å¤–å–/å’–å•¡
text: 'ã€ç¾¤èŠã€‘å¤–å–åˆ°äº†ï¼Œå¤§å®¶å…ˆåƒä¸¤å£å†ç»§ç»­ã€‚å’–å•¡æœºæ²¡æ°´äº†ï¼Œè°é¡ºä¾¿åŠ ä¸€ä¸‹ï¼Ÿ'

// å¤ç›˜ä¼š
text: 'ã€ç¾¤èŠã€‘é¡ºä¾¿è¯´ä¸€å¥ï¼Œæ˜å¤©å¤ç›˜ä¼šå‡ ç‚¹ï¼Ÿæˆ‘å¾—æå‰å‡†å¤‡ä¸€ä¸‹æœåŠ¡å™¨ç«¯çš„æ—¶é—´çº¿ã€‚'
```

---

## äº”ã€åœºæ™¯ ID å‘½åè§„èŒƒ

### åŸºç¡€ç¼–å·

- ä¸»çº¿åœºæ™¯ï¼š`scene-01`, `scene-02`, ...
- æ’å…¥åœºæ™¯ï¼šåœ¨åŸ ID ååŠ å­—æ¯ï¼Œå¦‚ `scene-06a`, `scene-13b`

### å‘½ååŸåˆ™

1. ä¿æŒé¡ºåºæ€§ï¼ˆä¾¿äºé˜…è¯»ï¼‰
2. æ’å…¥æ–°åœºæ™¯æ—¶ç”¨å­—æ¯åç¼€
3. é¿å…åˆ é™¤å·²æœ‰ IDï¼ˆå¯èƒ½è¢«æµ‹è¯•å¼•ç”¨ï¼‰

---

## å…­ã€æ ‡å‡†å†™ä½œæµç¨‹

### Step 1: è§„åˆ’æ—¶é—´çº¿

1. ç¡®å®šå‰§æƒ…èµ·æ­¢æ—¶é—´ï¼ˆå¦‚ 19:00-21:30ï¼‰
2. æ ‡è®°å…³é”®ä»»åŠ¡èŠ‚ç‚¹
3. è®¡ç®—æ¶ˆæ¯é—´éš”

### Step 2: è§’è‰²åˆ†é…

1. ç¡®å®šæ¯æ¡æ¶ˆæ¯çš„å‘é€è€…
2. ä¿æŒè§’è‰²é£æ ¼ä¸€è‡´
3. åˆç†åˆ†é…ç§èŠ/ç¾¤èŠ

### Step 3: å†™ä½œæ¶ˆæ¯å†…å®¹

1. å…ˆå†™ä¸»çº¿æ¶ˆæ¯ï¼ˆå¸¦ targetCaseId çš„ï¼‰
2. è¡¥å……æ•™å­¦é“ºå«ï¼ˆä»»åŠ¡å‰ 1-2 æ¡ï¼‰
3. æ·»åŠ é—²èŠè°ƒå‰‚ï¼ˆä»»åŠ¡åï¼‰
4. ä¸°å¯Œç§èŠå†…å®¹

### Step 4: é…ç½®å…ƒæ•°æ®

1. æ·»åŠ  timestamp
2. é…ç½® typingDelayï¼ˆé•¿æ¶ˆæ¯/é‡è¦æ¶ˆæ¯ï¼‰
3. æ£€æŸ¥ targetCaseId å’Œ requiresClueSync

### Step 5: éªŒè¯ä¸æµ‹è¯•

```bash
# æ„å»ºéªŒè¯è¯­æ³•
pnpm build

# è¿è¡Œ E2E æµ‹è¯•
pnpm exec playwright test --project=chromium tests/e2e/story-mode-wechat-*.spec.ts
```

---

## ä¸ƒã€æ‰¹é‡æ·»åŠ å†…å®¹çš„è„šæœ¬æ¨¡æ¿

### æ·»åŠ æ—¶é—´æˆ³

```javascript
// è¿è¡Œ: node scripts/add-timestamps.js
const fs = require('fs');
let content = fs.readFileSync('storylines.ts', 'utf8');

const timestamps = {
  'scene-02': '19:03',
  'scene-03': '19:05',
  // ... æ›´å¤šæ˜ å°„
};

for (const [sceneId, timestamp] of Object.entries(timestamps)) {
  const regex = new RegExp(
    `(id: '${sceneId}',[\\s\\S]*?text: '[^']+',)(?!\\s*\\n\\s*timestamp:)`,
    'g'
  );
  content = content.replace(regex, `$1\n      timestamp: '${timestamp}',`);
}

fs.writeFileSync('storylines.ts', content);
```

### æ’å…¥æ–°åœºæ™¯

```javascript
const fs = require('fs');
let content = fs.readFileSync('storylines.ts', 'utf8');

const afterSceneId = 'scene-13';
const newScene = `
    {
      id: 'scene-13a',
      sender: 'äº§å“',
      channel: 'WeChat',
      text: 'ã€ç¾¤èŠã€‘åˆšåˆšæ”¶åˆ° BI é‚£è¾¹çš„æ•°æ®ï¼Œä»Šæ™šè½¬åŒ–ç‡æ‰äº† 40%...',
      timestamp: '19:38',
      typingDelay: 1200,
    },`;

const pattern = `id: '${afterSceneId}'`;
const idx = content.indexOf(pattern);
const blockEnd = content.indexOf('},', idx) + 2;
content = content.slice(0, blockEnd) + newScene + content.slice(blockEnd);

fs.writeFileSync('storylines.ts', content);
```

---

## å…«ã€æ¡ä»¶æ¶ˆæ¯

### æ¡ä»¶è¡¨è¾¾å¼è¯­æ³•

åœ¨ `condition` å­—æ®µä¸­ä½¿ç”¨è¡¨è¾¾å¼æ§åˆ¶æ¶ˆæ¯æ˜¾ç¤ºï¼š

| è¡¨è¾¾å¼ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `completed:case_id` | æ£€æŸ¥å…³å¡æ˜¯å¦å®Œæˆ | `completed:story_01_login_outage` |
| `!completed:case_id` | æ£€æŸ¥å…³å¡æœªå®Œæˆ | `!completed:story_01` |
| `synced:clue_key` | æ£€æŸ¥çº¿ç´¢æ˜¯å¦å·²åŒæ­¥ | `synced:scene-07` |
| `progress>N` | æ£€æŸ¥è¿›åº¦å¤§äº N | `progress>5` |
| `progress>=N` | æ£€æŸ¥è¿›åº¦å¤§äºç­‰äº N | `progress>=10` |
| `all:cond1,cond2` | æ‰€æœ‰æ¡ä»¶éƒ½æ»¡è¶³ | `all:completed:story_01,completed:story_02` |
| `any:cond1,cond2` | ä»»ä¸€æ¡ä»¶æ»¡è¶³ | `any:completed:story_01,synced:clue-01` |

### ä½¿ç”¨ç¤ºä¾‹

```typescript
// å®Œæˆ story_01 åæ˜¾ç¤ºè€æ¿è¡¨æ‰¬
{
  id: 'scene-07-bonus',
  sender: 'è€æ¿',
  text: 'ã€ç¾¤èŠã€‘@ä½  å¤„ç†é€Ÿåº¦å¾ˆå¿«ï¼ç»§ç»­ä¿æŒã€‚',
  timestamp: '19:16',
  condition: 'completed:story_01_login_outage',
}

// åŒæ—¶å®Œæˆ story_01 å’Œ story_02 åæ˜¾ç¤º
{
  id: 'scene-13-bonus',
  sender: 'å®‰å…¨è´Ÿè´£äºº',
  text: 'ã€ç§èŠã€‘ä¸¤ä¸ªé—®é¢˜éƒ½å¤„ç†å¾—å¾ˆæ¼‚äº® ğŸ‘',
  timestamp: '19:36',
  condition: 'all:completed:story_01_login_outage,completed:story_02_price_tampering',
}
```

---

## ä¹ã€æ£€æŸ¥æ¸…å•

### å‘å¸ƒå‰æ£€æŸ¥

- [ ] æ‰€æœ‰æ¶ˆæ¯éƒ½æœ‰ timestamp
- [ ] é•¿æ¶ˆæ¯/ä»»åŠ¡æ¶ˆæ¯é…ç½®äº† typingDelay
- [ ] æ¯ä¸ª targetCaseId å‰æœ‰æ•™å­¦é“ºå«
- [ ] ç¾¤èŠ/ç§èŠå‰ç¼€æ­£ç¡®
- [ ] è§’è‰²è¯´è¯é£æ ¼ä¸€è‡´
- [ ] æ—¶é—´çº¿åˆç†ï¼ˆé—´éš”é€‚å½“ï¼‰
- [ ] `pnpm build` é€šè¿‡
- [ ] E2E æµ‹è¯•é€šè¿‡

---

## æ›´æ–°è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | æ›´æ–°å†…å®¹ |
|------|------|----------|
| 2025-01-25 | v1.0 | åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºäº P0/P1 å®ç°ç»éªŒæ•´ç† |
