# 第六课：HTTPS 证书配置

## 为什么需要安装证书？

### HTTPS 加密原理

```
普通 HTTP（明文）:
客户端 ←─── 数据明文传输 ───→ 服务器
         ↑
    任何人都能看到（包括抓包工具）

HTTPS（加密）:
客户端 ←─── TLS/SSL 加密 ───→ 服务器
         ↑
    密文，无法直接查看
```

### 抓包工具如何解密 HTTPS？

**中间人攻击（MITM - Man-In-The-Middle）合法应用**：

```
步骤1: 客户端 → Reqable（伪证书）
      客户端信任 Reqable 的证书，建立加密连接

步骤2: Reqable → 服务器（真证书）
      Reqable 用真证书连接服务器

步骤3: Reqable 解密流量
      Reqable 既能看到客户端发送的明文，也能看到服务器返回的明文
```

**关键**：客户端必须**信任** Reqable 的根证书，才能解密 HTTPS 流量。

---

## macOS 证书安装

### 1. 导出 Reqable 证书

**步骤**：

1. 打开 Reqable
2. 菜单栏 → **Reqable** → **证书管理**
3. 点击 **"导出根证书"**
4. 保存文件：`Reqable-Root-CA.crt`

### 2. 安装到系统钥匙串

**步骤**：

1. 双击 `Reqable-Root-CA.crt` 文件
2. 选择 **"系统"** 钥匙串（而非"登录"）
3. 输入 macOS 管理员密码
4. 证书安装完成

### 3. 信任证书

**关键步骤**：

1. 打开 **"钥匙串访问"** 应用
2. 左侧选择 **"系统"** → **"证书"**
3. 找到 **"Reqable Root CA"**
4. 双击证书 → 展开 **"信任"** 部分
5. 将 **"使用此证书时"** 改为 **"始终信任"**
6. 关闭窗口，输入密码确认

**验证**：证书图标应显示为蓝色"+"号（表示已信任）。

### 4. 测试

```bash
# 在终端运行
curl https://www.google.com -x http://127.0.0.1:8888

# 如果配置正确，应该返回 Google 首页 HTML
# 同时 Reqable 能看到这个 HTTPS 请求
```

---

## Windows 证书安装

### 1. 导出证书

同 macOS，导出 `Reqable-Root-CA.crt`。

### 2. 安装到受信任的根证书颁发机构

**步骤**：

1. 双击 `Reqable-Root-CA.crt`
2. 点击 **"安装证书"**
3. 存储位置选择 **"本地计算机"**（需要管理员权限）
4. 选择 **"将所有的证书都放入下列存储"**
5. 点击 **"浏览"** → 选择 **"受信任的根证书颁发机构"**
6. 点击 **"完成"**

### 3. 验证

1. 按 `Win + R` → 输入 `certmgr.msc`
2. 展开 **"受信任的根证书颁发机构"** → **"证书"**
3. 找到 **"Reqable Root CA"**

---

## iOS 证书安装（iPhone/iPad）

### 前置要求

- iOS 设备和电脑在**同一 Wi-Fi 网络**
- 知道电脑的 IP 地址（如 `192.168.1.100`）

### 1. 配置 iOS 设备的 Wi-Fi 代理

**步骤**：

1. 打开 **"设置"** → **"无线局域网"**
2. 点击已连接的 Wi-Fi 旁的 **"ⓘ"** 图标
3. 滚动到底部 → **"配置代理"**
4. 选择 **"手动"**
5. 填写：
   ```
   服务器: 192.168.1.100  ← 你的电脑 IP
   端口:   8888
   ```
6. 点击 **"存储"**

### 2. 下载并安装证书

**步骤**：

1. 在 iOS Safari 浏览器中访问：`http://192.168.1.100:8888`
2. 点击页面上的 **"下载证书"** 按钮
3. 提示"此网站正尝试下载配置描述文件" → 点击 **"允许"**
4. 打开 **"设置"** → **"已下载描述文件"** → 点击 **"Reqable Root CA"**
5. 点击 **"安装"** → 输入设备密码
6. 点击 **"安装"**（会有 3 次确认）

### 3. 启用完全信任

**iOS 10.3+ 必需步骤**：

1. 打开 **"设置"** → **"通用"** → **"关于本机"**
2. 滚动到底部 → **"证书信任设置"**
3. 找到 **"Reqable Root CA"**
4. 打开开关（变为绿色）
5. 点击 **"继续"** 确认

### 4. 测试

1. 在 Safari 中访问 `https://www.apple.com`
2. 在 Reqable 中应该能看到这个 HTTPS 请求

---

## Android 证书安装

### 方法 1：通过浏览器安装（适用于 Android 7-10）

**步骤**：

1. 配置 Android Wi-Fi 代理（类似 iOS）：
   - **设置** → **WLAN** → 长按已连接的 Wi-Fi → **修改网络**
   - 勾选 **"显示高级选项"**
   - **代理** 改为 **"手动"**
   - 填写 IP 和端口 `8888`

2. 浏览器访问 `http://192.168.1.100:8888`
3. 下载证书 `Reqable-Root-CA.crt`
4. 打开 **"设置"** → **"安全"** → **"从存储设备安装"**
5. 选择下载的证书文件
6. 证书名称输入 `Reqable`
7. 凭据用途选择 **"VPN 和应用"**

### 方法 2：Android 11+ (需要 ADB 或 Root)

**问题**：Android 11+ 默认不信任用户安装的证书。

**解决方案 A（ADB）**：

```bash
# 将证书推送到系统证书目录（需要 Root 权限或模拟器）
adb root
adb remount
adb push Reqable-Root-CA.crt /system/etc/security/cacerts/
adb reboot
```

**解决方案 B（应用级信任）**：

修改目标应用的 `AndroidManifest.xml`：

```xml
<application
    android:networkSecurityConfig="@xml/network_security_config">
```

创建 `res/xml/network_security_config.xml`：

```xml
<?xml version="1.0" encoding="utf-8"?>
<network-security-config>
    <base-config>
        <trust-anchors>
            <certificates src="system" />
            <certificates src="user" />  ← 信任用户证书
        </trust-anchors>
    </base-config>
</network-security-config>
```

---

## 常见问题

### Q: 为什么安装证书后仍无法抓 HTTPS？

**A**: 检查以下几点：

1. **证书未信任**：
   - macOS: 钥匙串中证书是否标记为"始终信任"？
   - iOS: 是否启用了"证书信任设置"？

2. **代理未生效**：
   - 运行 `curl https://www.google.com -x http://127.0.0.1:8888 -v`
   - 查看输出，确认是否走代理

3. **应用使用了证书固定（Certificate Pinning）**：
   - 部分 App（如银行 App、支付宝）会验证服务器证书指纹
   - 即使安装了代理证书，也会拒绝连接
   - **解决方案**：使用 Frida/Xposed 绕过（高级技巧，需谨慎）

### Q: 证书是否会泄露隐私？

**A**: **仅在本地使用是安全的**：

- ✅ Reqable 的证书**仅在你的设备上**生成和使用
- ✅ 私钥保存在本地，不会上传到任何服务器
- ❌ **不要**将证书安装到公司电脑或他人设备
- ❌ **不要**信任来源不明的证书

### Q: 如何卸载证书？

**macOS**：

```
钥匙串访问 → 系统 → 证书
→ 右键"Reqable Root CA" → 删除"Reqable Root CA"
```

**iOS**：

```
设置 → 通用 → VPN 与设备管理 → 配置描述文件
→ 点击"Reqable Root CA" → 移除描述文件
```

**Android**：

```
设置 → 安全 → 受信任的凭据 → 用户
→ 点击"Reqable" → 移除
```

### Q: 证书过期了怎么办？

**A**: Reqable 证书默认有效期 **1 年**：

1. 打开 Reqable → **证书管理**
2. 点击 **"重新生成证书"**
3. 重新导出并安装到设备

---

## 安全最佳实践

### ✅ 推荐做法

- 仅在**开发/测试设备**上安装证书
- 抓包完成后**及时移除**证书
- 不要在**生产环境**或**公司设备**上安装
- 定期**重新生成**证书（每 3-6 个月）

### ❌ 禁止行为

- 不要将证书文件分享给他人（私钥泄露风险）
- 不要在公共 Wi-Fi 下使用代理（可能被真正的中间人攻击）
- 不要信任来源不明的根证书

---

## 高级技巧

### 1. 仅抓特定域名的 HTTPS（减少证书警告）

**Reqable 规则配置**：

```yaml
规则名称: 仅抓 API 域名
触发条件: 域名匹配 api.example.com
动作: 解密 HTTPS
其他域名: 直接透传（不解密）
```

**优势**：减少其他网站的证书错误。

### 2. 使用 mitmproxy 的证书

如果你同时使用多个抓包工具，可以：

1. 导出 mitmproxy 的证书
2. 在 Reqable 中导入自定义证书
3. 所有工具共用一个证书，无需重复安装

### 3. 企业环境的证书管理

**场景**：团队所有成员需要抓包调试。

**解决方案**：

1. IT 管理员生成一个团队证书
2. 通过 MDM（移动设备管理）推送到所有设备
3. 集中管理证书的生命周期

---

## 实战练习

### 练习 1：验证证书安装

**任务**：确认能抓取 HTTPS 流量。

**步骤**：

1. 安装证书（按照上述步骤）
2. 打开 Reqable，点击"开始"
3. 浏览器访问 `https://www.github.com`
4. 在 Reqable 中应该能看到请求详情（包括请求/响应体）

### 练习 2：测试证书固定的 App

**任务**：找一个使用证书固定的 App（如支付宝）。

**步骤**：

1. 配置代理后打开支付宝
2. 观察现象：
   - 可能提示"网络错误"
   - Reqable 显示"SSL Handshake Failed"

**结论**：证书固定的 App 无法直接抓包，需要绕过技术（不在本课范围）。

### 练习 3：证书生命周期管理

**任务**：设置证书过期提醒。

**步骤**：

1. 在日历中标记证书安装日期
2. 设置 6 个月后的提醒"重新生成 Reqable 证书"
3. 到期后重新生成并安装

---

## 小结

✅ 你已经掌握：

- HTTPS 加密与解密原理
- 在 macOS/Windows/iOS/Android 上安装证书
- 常见问题的排查与解决
- 证书安全最佳实践

下一课：

- 📘 [第七课：安全测试入门](./07-security-testing-basics.md)
- 📘 [第八课：真实场景调试案例](./08-real-world-scenarios.md)

---

## 延伸阅读

- [TLS/SSL 握手过程详解](https://tls.ulfheim.net/)
- [Certificate Pinning 原理](https://owasp.org/www-community/controls/Certificate_and_Public_Key_Pinning)
- [iOS 证书信任设置文档](https://support.apple.com/en-us/HT204477)
